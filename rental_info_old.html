{% extends "base_old.html" %}

{% block title %}äº”æ¥¼ç®¡ç† - ç§Ÿæˆ¿ä¿¡æ¯ - ç§Ÿæˆ¿ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block page_title %}äº”æ¥¼ç®¡ç† - ç§Ÿæˆ¿ä¿¡æ¯{% endblock %}

{% block breadcrumb %}
    <div class="breadcrumb-container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index5') }}"><i class="fas fa-home"></i> ä¸»é¡µ</a></li>
                <li class="breadcrumb-item active">ç§Ÿæˆ¿ä¿¡æ¯</li>
            </ol>
        </nav>
    </div>
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/rental.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/info.css') }}">
{% endblock %}

{% block content %}
    <!-- å…¨å±€åŠ è½½åŠ¨ç”»è¦†ç›–å±‚ -->
    <div class="loading-overlay" id="globalLoadingOverlay">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...</p>
        </div>
    </div>

    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="rental-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2><i class="fas fa-info-circle me-3"></i> ç§Ÿæˆ¿ä¿¡æ¯</h2>
                <p><i class="fas fa-info-circle me-2"></i>æŸ¥çœ‹äº”æ¥¼æ‰€æœ‰æˆ¿é—´çš„ç§Ÿèµè¯¦ç»†ä¿¡æ¯</p>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="header-stats">
                    <div class="stat-item">
                        <i class="fas fa-calendar-alt"></i>
                        <span>{{ moment().format('YYYYå¹´MMæœˆDDæ—¥') if moment else 'ä»Šæ—¥' }}</span>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-clock"></i>
                        <span class="current-time" id="currentTime"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="row stats-row animate-fade-in">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card animate-scale-in" style="animation-delay: 0.1s;">
                <div class="stats-icon total">
                    <i class="fas fa-home"></i>
                </div>
                <div class="stats-content">
                    <h3>{{ rental_info_list|length }}</h3>
                    <p>æ€»ç§Ÿæˆ¿æ•°</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card animate-scale-in" style="animation-delay: 0.2s;">
                <div class="stats-icon paid">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stats-content">
                    <h3>{{ rental_info_list|selectattr('rental_status', 'equalto', 1)|list|length }}</h3>
                    <p>å·²ç¼´è´¹</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card animate-scale-in" style="animation-delay: 0.3s;">
                <div class="stats-icon unpaid">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div class="stats-content">
                    <h3>{{ rental_info_list|selectattr('rental_status', 'equalto', 2)|list|length }}</h3>
                    <p>æœªç¼´è´¹</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card animate-scale-in" style="animation-delay: 0.4s;">
                <div class="stats-icon deposit">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="stats-content">
                    <h3>Â¥{{ "%.2f"|format(rental_info_list|sum(attribute='deposit')|float) }}</h3>
                    <p>æ€»æŠ¼é‡‘</p>
                </div>
            </div>
        </div>
    </div>

    <!-- æ“ä½œæ  -->
    <div class="row mb-4 animate-slide-up">
        <div class="col-lg-6 col-md-12 mb-3 mb-lg-0">
            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="æœç´¢æˆ¿å·ã€ç§Ÿå®¢å§“åæˆ–ç”µè¯..."
                           class="form-control search-input">
                    <button class="btn btn-clear" id="clearSearch" title="æ¸…é™¤æœç´¢">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="search-suggestions" id="searchSuggestions" style="display: none;">
                    <!-- æœç´¢å»ºè®®å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                </div>
            </div>
        </div>
        <div class="col-lg-6 col-md-12">
            <div class="action-buttons d-flex flex-wrap gap-2 justify-content-end">
                <div class="btn-group" role="group">
                    <button class="btn export-btn" onclick="exportRentalInfo('all')" title="å¯¼å‡ºæ‰€æœ‰ç§Ÿæˆ¿ä¿¡æ¯">
                        <i class="fas fa-file-excel me-1"></i> å¯¼å‡ºä¿¡æ¯
                    </button>
                    <button type="button" class="btn export-btn dropdown-toggle dropdown-toggle-split"
                            data-bs-toggle="dropdown" aria-expanded="false">
                        <span class="visually-hidden">æ›´å¤šé€‰é¡¹</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" onclick="exportRentalInfo('paid')">
                            <i class="fas fa-check text-success me-2"></i> å¯¼å‡ºå·²ç¼´è´¹ä¿¡æ¯</a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportRentalInfo('unpaid')">
                            <i class="fas fa-times text-danger me-2"></i> å¯¼å‡ºæœªç¼´è´¹ä¿¡æ¯</a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item" href="#" onclick="showRentalInfoSummary()">
                            <i class="fas fa-chart-bar text-primary me-2"></i> ç§Ÿæˆ¿ä¿¡æ¯æ±‡æ€»</a></li>
                    </ul>
                </div>
                <button class="btn add-rental-btn" onclick="addRentalInfo()">
                    <i class="fas fa-plus me-1"></i> æ·»åŠ ç§Ÿæˆ¿ä¿¡æ¯
                </button>
            </div>
        </div>
    </div>

    <!-- ç­›é€‰æŒ‰é’® -->
    <div class="filter-buttons mt-3 animate-fade-in">
        <button class="btn filter-btn active" data-filter="all">
            <i class="fas fa-list"></i> å…¨éƒ¨
        </button>
        <button class="btn filter-btn" data-filter="paid">
            <i class="fas fa-check-circle"></i> å·²ç¼´è´¹
        </button>
        <button class="btn filter-btn" data-filter="unpaid">
            <i class="fas fa-exclamation-circle"></i> æœªç¼´è´¹
        </button>
    </div>

    <!-- ç§Ÿæˆ¿ä¿¡æ¯è¡¨æ ¼ -->
    <div class="table-responsive rental-info-table animate-fade-in" style="animation-delay: 0.3s;">
        <table class="table table-hover table-striped">
            <thead>
            <tr>
                <th>æˆ¿å·</th>
                <th>ç§Ÿå®¢å§“å</th>
                <th>ç”µè¯</th>
                <th>æŠ¼é‡‘</th>
                <th>å…¥ä½äººæ•°</th>
                <th>å…¥ä½æ—¶é—´</th>
                <th>ç¼´è´¹çŠ¶æ€</th>
                <th>å¤‡æ³¨</th>
                <th>æ“ä½œ</th>
            </tr>
            </thead>
            <tbody>
            {% for info in rental_info_list %}
                <tr data-rental-info-id="{{ info.id }}"
                    class="rental-info-row {% if info.rental_status == 2 %}unpaid-row{% endif %}">
                    <td>
                        <span class="room-badge">
                            <i class="fas fa-home me-1"></i> {{ info.room_number }}
                        </span>
                    </td>
                    <td>
                        <div class="tenant-info">
                            <i class="fas fa-user me-2"></i>
                            <span class="tenant-name">{{ info.tenant_name }}</span>
                        </div>
                    </td>
                    <td>
                        <div class="phone-info">
                            <i class="fas fa-phone me-2 text-muted"></i>
                            <span>{{ info.phone }}</span>
                        </div>
                    </td>
                    <td class="money-amount amount-positive">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-money-bill me-2 text-muted"></i>
                            <span>Â¥{{ "%.2f"|format(info.deposit|float) }}</span>
                        </div>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-users me-2 text-muted"></i>
                            <span>{{ info.occupant_count }}</span>
                        </div>
                    </td>
                    <td>
                        {% if info.check_in_date %}
                            <span class="date-info">{{ info.check_in_date.strftime('%Y-%m-%d') }}</span>
                        {% else %}
                            <span class="text-muted">æœªå…¥ä½</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if info.rental_status == 1 %}
                            <span class="payment-status status-paid">
                                <i class="fas fa-check-circle"></i> å·²ç¼´è´¹
                            </span>
                        {% else %}
                            <span class="payment-status status-unpaid">
                                <i class="fas fa-exclamation-circle"></i> æœªç¼´è´¹
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        {% if info.remarks %}
                            <span class="remarks-text" title="{{ info.remarks }}">{{ info.remarks }}</span>
                        {% else %}
                            <span class="text-muted">æ— </span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-action btn-view" onclick="viewRentalInfo({{ info.id }})"
                                    title="æŸ¥çœ‹è¯¦æƒ…">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-action btn-edit" onclick="editRentalInfo({{ info.id }})"
                                    title="ç¼–è¾‘ä¿¡æ¯">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-action btn-delete" onclick="deleteRentalInfo({{ info.id }})"
                                    title="åˆ é™¤ä¿¡æ¯">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="9" class="text-center py-5">
                        <div class="empty-state animate-fade-in">
                            <i class="fas fa-info-circle fa-3x mb-3"></i>
                            <h5>æš‚æ— ç§Ÿæˆ¿ä¿¡æ¯</h5>
                            <p class="text-muted">ç‚¹å‡»"æ·»åŠ ç§Ÿæˆ¿ä¿¡æ¯"æŒ‰é’®åˆ›å»ºæ–°çš„ç§Ÿæˆ¿ä¿¡æ¯è®°å½•</p>
                            <button class="btn btn-primary mt-2" onclick="addRentalInfo()">
                                <i class="fas fa-plus me-1"></i> æ·»åŠ ç§Ÿæˆ¿ä¿¡æ¯
                            </button>
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘ç§Ÿæˆ¿ä¿¡æ¯æ¨¡æ€æ¡† -->
    <div class="modal fade animate-modal" id="rentalInfoModal" tabindex="-1" aria-labelledby="rentalInfoModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content animate-scale-in">
                <div class="modal-header bg-gradient-primary text-white">
                    <h5 class="modal-title" id="rentalInfoModalLabel">
                        <i class="fas fa-home me-2"></i>
                        <span id="rentalModalTitle">æ·»åŠ ç§Ÿæˆ¿ä¿¡æ¯</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="rentalInfoForm" class="needs-validation" novalidate>
                        <input type="hidden" id="rentalInfoId" name="id">

                        <!-- åŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
                        <div class="form-section-card">
                            <div class="section-header">
                                <i class="fas fa-info-circle"></i>
                                <h6>åŸºæœ¬ä¿¡æ¯</h6>
                            </div>
                            <div class="section-content">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="roomNumber" class="form-label">
                                            <i class="fas fa-door-open text-primary me-2"></i>æˆ¿å·
                                            <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-home text-primary"></i>
                                            </span>
                                            <select class="form-select form-select-lg" id="roomNumber" name="roomNumber"
                                                    required>
                                                <option value="">è¯·é€‰æ‹©ç©ºé—²æˆ¿é—´</option>
                                            </select>
                                            <div class="invalid-feedback">
                                                <i class="fas fa-exclamation-triangle me-1"></i>è¯·é€‰æ‹©æˆ¿å·
                                            </div>
                                        </div>
                                        <div class="form-text text-muted mt-2">
                                            <i class="fas fa-info-circle me-1"></i>ä»…æ˜¾ç¤ºç©ºé—²çŠ¶æ€çš„æˆ¿é—´
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="tenantName" class="form-label">
                                            <i class="fas fa-user text-primary me-2"></i>ç§Ÿå®¢å§“å
                                            <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-user text-primary"></i>
                                            </span>
                                            <input type="text" class="form-control" id="tenantName" name="tenantName"
                                                   placeholder="è¯·è¾“å…¥ç§Ÿå®¢å§“å" required>
                                            <div class="invalid-feedback">
                                                <i class="fas fa-exclamation-triangle me-1"></i>è¯·è¾“å…¥ç§Ÿå®¢å§“å
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- è”ç³»ä¿¡æ¯å¡ç‰‡ -->
                        <div class="form-section-card">
                            <div class="section-header">
                                <i class="fas fa-phone"></i>
                                <h6>è”ç³»ä¿¡æ¯</h6>
                            </div>
                            <div class="section-content">
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label for="phone" class="form-label">
                                            <i class="fas fa-phone text-primary me-2"></i>è”ç³»ç”µè¯
                                            <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-phone text-primary"></i>
                                            </span>
                                            <input type="tel" class="form-control" id="phone" name="phone"
                                                   placeholder="è¯·è¾“å…¥æ‰‹æœºå·ç " pattern="[0-9]{11}" required>
                                            <div class="invalid-feedback">
                                                <i class="fas fa-exclamation-triangle me-1"></i>è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç 
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- è´¢åŠ¡ä¿¡æ¯å¡ç‰‡ -->
                        <div class="form-section-card">
                            <div class="section-header">
                                <i class="fas fa-money-bill-wave"></i>
                                <h6>è´¢åŠ¡ä¿¡æ¯</h6>
                            </div>
                            <div class="section-content">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="deposit" class="form-label">
                                            <i class="fas fa-coins text-success me-2"></i>æŠ¼é‡‘é‡‘é¢
                                            <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-text bg-light text-success fw-bold">Â¥</span>
                                            <input type="number" class="form-control text-success fw-bold"
                                                   id="deposit" name="deposit" min="0" step="100"
                                                   value="200" placeholder="200.00" required>
                                            <div class="invalid-feedback">
                                                <i class="fas fa-exclamation-triangle me-1"></i>è¯·è¾“å…¥æŠ¼é‡‘é‡‘é¢
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="rentalStatus" class="form-label">
                                            <i class="fas fa-check-circle text-info me-2"></i>ç¼´è´¹çŠ¶æ€
                                            <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-info-circle text-info"></i>
                                            </span>
                                            <select class="form-select" id="rentalStatus" required>
                                                <option value="">é€‰æ‹©ç¼´è´¹çŠ¶æ€</option>
                                                <option value="1" class="text-success">
                                                    <i class="fas fa-check-circle"></i> å·²ç¼´è´¹
                                                </option>
                                                <option value="2" class="text-danger">
                                                    <i class="fas fa-exclamation-circle"></i> æœªç¼´è´¹
                                                </option>
                                            </select>
                                            <div class="invalid-feedback">
                                                <i class="fas fa-exclamation-triangle me-1"></i>è¯·é€‰æ‹©ç¼´è´¹çŠ¶æ€
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- å…¥ä½ä¿¡æ¯å¡ç‰‡ -->
                        <div class="form-section-card">
                            <div class="section-header">
                                <i class="fas fa-users"></i>
                                <h6>å…¥ä½ä¿¡æ¯</h6>
                            </div>
                            <div class="section-content">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="occupantCount" class="form-label">
                                            <i class="fas fa-user-friends text-primary me-2"></i>å…¥ä½äººæ•°
                                            <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-users text-primary"></i>
                                            </span>
                                            <input type="number" class="form-control" id="occupantCount"
                                                   name="occupantCount" min="1" max="10" placeholder="1" required>
                                            <span class="input-group-text">äºº</span>
                                            <div class="invalid-feedback">
                                                <i class="fas fa-exclamation-triangle me-1"></i>è¯·è¾“å…¥å…¥ä½äººæ•°
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="checkInDate" class="form-label">
                                            <i class="fas fa-calendar-alt text-primary me-2"></i>å…¥ä½æ—¶é—´
                                        </label>
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-calendar text-primary"></i>
                                            </span>
                                            <input type="date" class="form-control" id="checkInDate"
                                                   name="checkInDate">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- å¤‡æ³¨ä¿¡æ¯å¡ç‰‡ -->
                        <div class="form-section-card">
                            <div class="section-header">
                                <i class="fas fa-sticky-note"></i>
                                <h6>å¤‡æ³¨ä¿¡æ¯</h6>
                            </div>
                            <div class="section-content">
                                <label for="remarks" class="form-label">
                                    <i class="fas fa-edit text-muted me-2"></i>å¤‡æ³¨è¯´æ˜
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light">
                                        <i class="fas fa-sticky-note text-muted"></i>
                                    </span>
                                    <textarea class="form-control form-control-lg" id="remarks" name="remarks"
                                              rows="4" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯ï¼ˆé€‰å¡«ï¼‰"></textarea>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>å–æ¶ˆ
                    </button>
                    <button type="button" class="btn btn-success" id="saveRentalInfo">
                        <i class="fas fa-save me-1"></i>
                        <span id="saveButtonText">ä¿å­˜ä¿¡æ¯</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æŸ¥çœ‹ç§Ÿæˆ¿ä¿¡æ¯è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal fade animate-modal" id="viewRentalInfoModal" tabindex="-1"
         aria-labelledby="viewRentalInfoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content animate-scale-in">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewRentalInfoModalLabel"><i class="fas fa-info-circle me-2"></i>ç§Ÿæˆ¿ä¿¡æ¯è¯¦æƒ…
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="viewRentalInfoBody">
                    <div class="text-center py-5" id="loadingSpinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">åŠ è½½ä¸­...</p>
                    </div>
                    <div id="rentalInfoDetails" class="animate-fade-in" style="display: none;">
                        <!-- ç§Ÿæˆ¿ä¿¡æ¯è¯¦æƒ…å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>å…³é—­
                    </button>
                    <button type="button" class="btn btn-primary" id="editFromView">
                        <i class="fas fa-edit me-1"></i>ç¼–è¾‘
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="modal fade animate-modal" id="deleteRentalInfoModal" tabindex="-1"
         aria-labelledby="deleteRentalInfoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content animate-scale-in">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteRentalInfoModalLabel"><i
                            class="fas fa-exclamation-triangle me-2"></i>ç¡®è®¤åˆ é™¤</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i class="fas fa-trash-alt text-danger fa-3x mb-3"></i>
                        <p class="lead">ç¡®å®šè¦åˆ é™¤è¿™æ¡ç§Ÿæˆ¿ä¿¡æ¯è®°å½•å—ï¼Ÿ</p>
                        <p class="text-muted">æ­¤æ“ä½œä¸å¯æ¢å¤ã€‚</p>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="deleteRentalInfoWarning"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>å–æ¶ˆ
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteRentalInfo">
                        <i class="fas fa-trash-alt me-1"></i>ç¡®è®¤åˆ é™¤
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        // æ›´æ–°å½“å‰æ—¶é—´
        function updateCurrentTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            const timeElement = document.getElementById('currentTime');
            timeElement.textContent = `${hours}:${minutes}:${seconds}`;

            // æ·»åŠ æ—¶é—´æ›´æ–°åŠ¨ç”»
            timeElement.classList.add('time-update-pulse');
            setTimeout(() => {
                timeElement.classList.remove('time-update-pulse');
            }, 500);
        }

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function () {
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            const loadingOverlay = document.getElementById('globalLoadingOverlay');
            loadingOverlay.classList.add('show');

            // é¡µé¢åŠ è½½å®Œæˆåéšè—åŠ è½½åŠ¨ç”»
            setTimeout(function () {
                loadingOverlay.classList.remove('show');
            }, 800);

            // æ›´æ–°æ—¶é—´
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);

            // æ·»åŠ è¡¨å•éªŒè¯
            (function () {
                'use strict';

                // è·å–æ‰€æœ‰éœ€è¦éªŒè¯çš„è¡¨å•
                const forms = document.querySelectorAll('.needs-validation');

                // å¾ªç¯å¹¶é˜»æ­¢æäº¤
                Array.from(forms).forEach(form => {
                    form.addEventListener('submit', event => {
                        if (!form.checkValidity()) {
                            event.preventDefault();
                            event.stopPropagation();
                        }

                        form.classList.add('was-validated');
                    }, false);
                });
            })();

            // ç­›é€‰æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.filter-btn').forEach(button => {
                button.addEventListener('click', function () {
                    // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });

                    // æ·»åŠ å½“å‰æŒ‰é’®çš„activeç±»
                    this.classList.add('active');

                    // è·å–ç­›é€‰å€¼
                    const filter = this.getAttribute('data-filter');

                    // ç­›é€‰è¡¨æ ¼è¡Œ
                    const rows = document.querySelectorAll('.rental-info-row');
                    rows.forEach(row => {
                        if (filter === 'all') {
                            row.style.display = '';
                        } else if (filter === 'paid' && !row.classList.contains('unpaid-row')) {
                            row.style.display = '';
                        } else if (filter === 'unpaid' && row.classList.contains('unpaid-row')) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    });
                });
            });

            // æœç´¢åŠŸèƒ½
            const searchInput = document.getElementById('searchInput');
            const clearSearch = document.getElementById('clearSearch');
            const searchSuggestions = document.getElementById('searchSuggestions');
            let selectedSuggestionIndex = -1;

            // è·å–æ‰€æœ‰ç§Ÿæˆ¿æ•°æ®ç”¨äºæœç´¢å»ºè®®
            const rentalData = [];
            document.querySelectorAll('.rental-info-row').forEach(row => {
                const roomNumber = row.querySelector('.room-badge').textContent.trim().replace('ğŸ ', '').trim();
                const tenantName = row.querySelector('.tenant-name').textContent.trim();
                const phone = row.querySelector('.phone-info span').textContent.trim();

                rentalData.push({
                    roomNumber: roomNumber,
                    tenantName: tenantName,
                    phone: phone,
                    element: row
                });
            });

            // é˜²æŠ–å‡½æ•°
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // æœç´¢å‡½æ•°
            function performSearch() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                const rows = document.querySelectorAll('.rental-info-row');
                let visibleCount = 0;
                selectedSuggestionIndex = -1;

                if (searchTerm === '') {
                    // å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼Œæ˜¾ç¤ºæ‰€æœ‰è¡Œ
                    rows.forEach(row => {
                        row.style.display = '';
                        row.classList.remove('search-highlight');
                        visibleCount++;
                    });
                    searchSuggestions.style.display = 'none';
                    updateSearchResultsInfo(visibleCount, rows.length);
                    return;
                }

                // æœç´¢åŒ¹é…
                const suggestions = [];
                rows.forEach(row => {
                    const roomNumber = row.querySelector('.room-badge').textContent.trim().replace(/ğŸ |\s/g, '').toLowerCase();
                    const tenantName = row.querySelector('.tenant-name').textContent.toLowerCase().trim();
                    const phone = row.querySelector('.phone-info span').textContent.toLowerCase().trim();

                    const isMatch = roomNumber.includes(searchTerm) ||
                        tenantName.includes(searchTerm) ||
                        phone.includes(searchTerm);

                    if (isMatch) {
                        row.style.display = '';
                        row.classList.add('search-highlight');
                        visibleCount++;

                        // é«˜äº®åŒ¹é…çš„æ–‡æœ¬
                        highlightSearchText(row, searchTerm);
                    } else {
                        row.style.display = 'none';
                        row.classList.remove('search-highlight');
                        clearHighlight(row);
                    }
                });

                // ç”Ÿæˆæœç´¢å»ºè®®
                if (searchTerm.length > 0) {
                    generateSearchSuggestions(searchTerm, rentalData, suggestions);
                }

                updateSearchResultsInfo(visibleCount, rows.length);
            }

            // æ·»åŠ é˜²æŠ–çš„æœç´¢äº‹ä»¶ç›‘å¬
            searchInput.addEventListener('input', debounce(performSearch, 300));

            // é”®ç›˜å¯¼èˆª
            searchInput.addEventListener('keydown', function (e) {
                const suggestionItems = searchSuggestions.querySelectorAll('.search-suggestion-item');

                if (suggestionItems.length === 0) return;

                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestionItems.length - 1);
                        updateSuggestionSelection(suggestionItems);
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                        updateSuggestionSelection(suggestionItems);
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (selectedSuggestionIndex >= 0 && selectedSuggestionIndex < suggestionItems.length) {
                            suggestionItems[selectedSuggestionIndex].click();
                        }
                        break;
                    case 'Escape':
                        searchSuggestions.style.display = 'none';
                        selectedSuggestionIndex = -1;
                        break;
                }
            });

            // æ¸…é™¤æœç´¢
            clearSearch.addEventListener('click', function () {
                searchInput.value = '';
                const rows = document.querySelectorAll('.rental-info-row');
                rows.forEach(row => {
                    row.style.display = '';
                    row.classList.remove('search-highlight');
                    clearHighlight(row);
                });
                searchSuggestions.style.display = 'none';
                selectedSuggestionIndex = -1;
                updateSearchResultsInfo(rows.length, rows.length);
            });

            // æœç´¢æ¡†è·å¾—ç„¦ç‚¹æ—¶æ˜¾ç¤ºæœç´¢å†å²
            searchInput.addEventListener('focus', function () {
                if (this.value.trim() === '') {
                    const history = getSearchHistory();
                    if (history.length > 0) {
                        let suggestionsHTML = '<div class="search-history-header">æœ€è¿‘æœç´¢</div>';
                        history.slice(0, 5).forEach(term => {
                            suggestionsHTML += `
                                <div class="search-suggestion-item search-history-item" data-search-term="${term}">
                                    <i class="fas fa-history me-2 text-muted"></i>
                                    <span class="suggestion-history">${term}</span>
                                    <button class="btn btn-sm btn-link ms-auto p-0 text-muted remove-history" data-term="${term}" title="åˆ é™¤">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            `;
                        });

                        searchSuggestions.innerHTML = suggestionsHTML;
                        searchSuggestions.style.display = 'block';
                        addSuggestionClickEvents();
                        addRemoveHistoryEvents();
                    }
                }
            });

            // åˆ é™¤æœç´¢å†å²äº‹ä»¶
            function addRemoveHistoryEvents() {
                searchSuggestions.querySelectorAll('.remove-history').forEach(btn => {
                    btn.addEventListener('click', function (e) {
                        e.stopPropagation();
                        const term = this.dataset.term;
                        removeSearchHistory(term);

                        // é‡æ–°æ˜¾ç¤ºå†å²
                        if (searchInput.value.trim() === '') {
                            searchInput.focus();
                        }
                    });
                });
            }

            // åˆ é™¤æœç´¢å†å²é¡¹
            function removeSearchHistory(termToRemove) {
                let history = getSearchHistory();
                history = history.filter(term => term !== termToRemove);
                localStorage.setItem('rentalSearchHistory', JSON.stringify(history));
            }

            // ç‚¹å‡»å¤–éƒ¨æ—¶éšè—æœç´¢å»ºè®®
            document.addEventListener('click', function (event) {
                if (!event.target.closest('.search-container')) {
                    searchSuggestions.style.display = 'none';
                }
            });

            // é«˜äº®æœç´¢æ–‡æœ¬
            function highlightSearchText(row, searchTerm) {
                const elements = [
                    row.querySelector('.room-badge'),
                    row.querySelector('.tenant-name'),
                    row.querySelector('.phone-info span')
                ];

                elements.forEach(element => {
                    if (element) {
                        const text = element.textContent;
                        const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                        if (regex.test(text)) {
                            element.innerHTML = text.replace(regex, '<mark class="search-match">$1</mark>');
                        }
                    }
                });
            }

            // æ¸…é™¤é«˜äº®
            function clearHighlight(row) {
                const elements = [
                    row.querySelector('.room-badge'),
                    row.querySelector('.tenant-name'),
                    row.querySelector('.phone-info span')
                ];

                elements.forEach(element => {
                    if (element && element.querySelector('mark')) {
                        element.innerHTML = element.textContent;
                    }
                });
            }

            // ç”Ÿæˆæœç´¢å»ºè®®
            function generateSearchSuggestions(searchTerm, data, suggestions) {
                selectedSuggestionIndex = -1;

                // è·å–æ™ºèƒ½åŒ¹é…ç»“æœ
                const matches = data.map(item => {
                    const roomScore = getMatchScore(item.roomNumber, searchTerm);
                    const nameScore = getMatchScore(item.tenantName, searchTerm);
                    const phoneScore = getMatchScore(item.phone, searchTerm);
                    const maxScore = Math.max(roomScore, nameScore, phoneScore);

                    return {
                        ...item,
                        score: maxScore,
                        matchType: roomScore === maxScore ? 'room' :
                            nameScore === maxScore ? 'name' : 'phone'
                    };
                }).filter(item => item.score > 0)
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 5);

                // å¦‚æœæ²¡æœ‰åŒ¹é…é¡¹ï¼Œæ˜¾ç¤ºæœç´¢å†å²
                if (matches.length === 0 && searchTerm.length > 0) {
                    const history = getSearchHistory().filter(term =>
                        term.toLowerCase().includes(searchTerm.toLowerCase())
                    ).slice(0, 3);

                    if (history.length > 0) {
                        let suggestionsHTML = '<div class="search-history-header">æœç´¢å†å²</div>';
                        history.forEach(term => {
                            suggestionsHTML += `
                                <div class="search-suggestion-item search-history-item" data-search-term="${term}">
                                    <i class="fas fa-history me-2 text-muted"></i>
                                    <span class="suggestion-history">${term}</span>
                                </div>
                            `;
                        });

                        searchSuggestions.innerHTML = suggestionsHTML;
                        searchSuggestions.style.display = 'block';
                        addSuggestionClickEvents();
                        return;
                    }
                }

                if (matches.length > 0) {
                    let suggestionsHTML = '';
                    matches.forEach(match => {
                        const highlightClass = match.matchType === 'room' ? 'text-primary' :
                            match.matchType === 'name' ? 'text-success' : 'text-info';

                        suggestionsHTML += `
                            <div class="search-suggestion-item" data-room="${match.roomNumber}" data-tenant="${match.tenantName}" data-phone="${match.phone}">
                                <i class="fas fa-home me-2 ${highlightClass}"></i>
                                <span class="suggestion-room ${match.matchType === 'room' ? highlightClass : ''}">${highlightSearchTerm(match.roomNumber, searchTerm)}</span>
                                <span class="suggestion-tenant ${match.matchType === 'name' ? highlightClass : ''}">${highlightSearchTerm(match.tenantName, searchTerm)}</span>
                                <span class="suggestion-phone text-muted ${match.matchType === 'phone' ? highlightClass : ''}">${highlightSearchTerm(match.phone, searchTerm)}</span>
                            </div>
                        `;
                    });

                    searchSuggestions.innerHTML = suggestionsHTML;
                    searchSuggestions.style.display = 'block';
                    addSuggestionClickEvents();
                } else {
                    searchSuggestions.style.display = 'none';
                }
            }

            // é«˜äº®å»ºè®®ä¸­çš„æœç´¢è¯
            function highlightSearchTerm(text, searchTerm) {
                if (!searchTerm || searchTerm.length < 1) return text;

                const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                return text.replace(regex, '<strong>$1</strong>');
            }

            // æ·»åŠ å»ºè®®é¡¹ç‚¹å‡»äº‹ä»¶
            function addSuggestionClickEvents() {
                searchSuggestions.querySelectorAll('.search-suggestion-item').forEach(item => {
                    item.addEventListener('click', function () {
                        let searchValue = '';

                        if (this.classList.contains('search-history-item')) {
                            searchValue = this.dataset.searchTerm;
                        } else {
                            // æ ¹æ®åŒ¹é…ç±»å‹é€‰æ‹©æœç´¢å€¼
                            const room = this.dataset.room;
                            const tenant = this.dataset.tenant;
                            const phone = this.dataset.phone;

                            // ä¼˜å…ˆä½¿ç”¨ç§Ÿå®¢å§“åï¼Œå› ä¸ºè¿™æ˜¯æœ€å¸¸ç”¨çš„æœç´¢æ–¹å¼
                            searchValue = tenant || room || phone;
                        }

                        searchInput.value = searchValue;
                        saveSearchHistory(searchValue);

                        // è§¦å‘æœç´¢
                        performSearch();
                        searchSuggestions.style.display = 'none';
                        selectedSuggestionIndex = -1;
                    });
                });
            }

            // æ›´æ–°å»ºè®®é€‰æ‹©çŠ¶æ€
            function updateSuggestionSelection(suggestionItems) {
                suggestionItems.forEach((item, index) => {
                    if (index === selectedSuggestionIndex) {
                        item.classList.add('selected');
                        item.scrollIntoView({block: 'nearest'});
                    } else {
                        item.classList.remove('selected');
                    }
                });
            }

            // æ›´æ–°æœç´¢ç»“æœä¿¡æ¯
            function updateSearchResultsInfo(visibleCount, totalCount) {
                // åœ¨æœç´¢æ¡†ä¸‹æ–¹æ˜¾ç¤ºæœç´¢ç»“æœç»Ÿè®¡
                let resultInfo = document.querySelector('.search-result-info');
                if (!resultInfo) {
                    resultInfo = document.createElement('div');
                    resultInfo.className = 'search-result-info mt-2 text-muted small';
                    searchInput.parentNode.parentNode.appendChild(resultInfo);
                }

                if (searchInput.value.trim() !== '') {
                    resultInfo.textContent = `æ‰¾åˆ° ${visibleCount} æ¡è®°å½•ï¼ˆå…± ${totalCount} æ¡ï¼‰`;
                    resultInfo.style.display = 'block';
                } else {
                    resultInfo.style.display = 'none';
                }
            }

            // æ™ºèƒ½æœç´¢åŒ¹é…å‡½æ•°
            function getMatchScore(text, searchTerm) {
                text = text.toLowerCase();
                searchTerm = searchTerm.toLowerCase();

                if (text === searchTerm) return 100;
                if (text.startsWith(searchTerm)) return 80;
                if (text.includes(searchTerm)) return 60;

                // æ¨¡ç³ŠåŒ¹é…
                let score = 0;
                let searchIndex = 0;
                for (let i = 0; i < text.length && searchIndex < searchTerm.length; i++) {
                    if (text[i] === searchTerm[searchIndex]) {
                        score++;
                        searchIndex++;
                    }
                }
                return searchIndex === searchTerm.length ? score * 2 : 0;
            }

            // è·å–æœç´¢å†å²
            function getSearchHistory() {
                const history = localStorage.getItem('rentalSearchHistory');
                return history ? JSON.parse(history) : [];
            }

            // ä¿å­˜æœç´¢å†å²
            function saveSearchHistory(searchTerm) {
                if (searchTerm.trim().length < 2) return;

                let history = getSearchHistory();
                history = history.filter(item => item !== searchTerm);
                history.unshift(searchTerm);
                history = history.slice(0, 10); // ä¿ç•™æœ€è¿‘10æ¡

                localStorage.setItem('rentalSearchHistory', JSON.stringify(history));
            }
        });

        // ä¿å­˜ç§Ÿæˆ¿ä¿¡æ¯
        document.getElementById('saveRentalInfo').addEventListener('click', function () {
            const form = document.getElementById('rentalInfoForm');
            const formData = new FormData(form);
            const id = document.getElementById('rentalInfoId').value;

            // éªŒè¯è¡¨å•
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }

            // æ„å»ºæ•°æ®å¯¹è±¡
            const data = {
                room_number: formData.get('roomNumber'),
                tenant_name: formData.get('tenantName'),
                phone: formData.get('phone'),
                deposit: formData.get('deposit'),
                occupant_count: formData.get('occupantCount'),
                check_in_date: formData.get('checkInDate'),
                rental_status: document.getElementById('rentalStatus').value,
                remarks: document.getElementById('remarks').value
            };

            // å‘é€è¯·æ±‚
            const url = id ? `/api/rental_info_old/${id}` : '/api/rental_info_old';
            const method = id ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(data.message, 'success');
                        // å…³é—­æ¨¡æ€æ¡†
                        const modal = bootstrap.Modal.getInstance(document.getElementById('rentalInfoModal'));
                        modal.hide();
                        // åˆ·æ–°é¡µé¢
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } else {
                        showNotification(data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('ä¿å­˜å¤±è´¥:', error);
                    showNotification('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
                });
        });

        // é€šçŸ¥ç³»ç»Ÿ
        function showNotification(message, type = 'info') {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show notification-toast`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;

            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(notification);

            // è‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // æ·»åŠ ç§Ÿæˆ¿ä¿¡æ¯
        function addRentalInfo() {
            // é‡ç½®è¡¨å•
            document.getElementById('rentalInfoForm').reset();
            document.getElementById('rentalInfoForm').classList.remove('was-validated');
            document.getElementById('rentalInfoId').value = '';
            document.getElementById('rentalInfoModalLabel').innerHTML = '<i class="fas fa-plus me-2"></i>æ·»åŠ ç§Ÿæˆ¿ä¿¡æ¯';

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modal = new bootstrap.Modal(document.getElementById('rentalInfoModal'));
            modal.show();
        }

        // æŸ¥çœ‹ç§Ÿæˆ¿ä¿¡æ¯è¯¦æƒ…
        function viewRentalInfo(id) {
            const loadingSpinner = document.getElementById('loadingSpinner');
            const rentalInfoDetails = document.getElementById('rentalInfoDetails');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            loadingSpinner.style.display = 'block';
            rentalInfoDetails.style.display = 'none';

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modal = new bootstrap.Modal(document.getElementById('viewRentalInfoModal'));
            modal.show();

            // å‘é€AJAXè¯·æ±‚è·å–è¯¦ç»†ä¿¡æ¯
            fetch(`/api/rental_info_old/${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // æ„å»ºè¯¦æƒ…HTML - ç¾åŒ–ç‰ˆ
                    const detailsHTML = `
                        <div class="detail-header">
                            <div class="detail-icon">
                                <i class="fas fa-home"></i>
                            </div>
                            <div class="detail-title">
                                <h4>æˆ¿å· ${data.room_number}</h4>
                                <span class="status-badge ${data.rental_status === 1 ? 'status-paid' : 'status-unpaid'}">
                                    ${data.rental_status_text}
                                </span>
                            </div>
                        </div>
                        
                        <div class="detail-cards">
                            <!-- ç§Ÿå®¢ä¿¡æ¯å¡ç‰‡ -->
                            <div class="detail-card">
                                <div class="card-header">
                                    <i class="fas fa-user-circle"></i>
                                    <span>ç§Ÿå®¢ä¿¡æ¯</span>
                                </div>
                                <div class="card-body">
                                    <div class="info-row">
                                        <i class="fas fa-user text-primary"></i>
                                        <span class="label">ç§Ÿå®¢å§“å</span>
                                        <span class="value">${data.tenant_name}</span>
                                    </div>
                                    <div class="info-row">
                                        <i class="fas fa-phone text-success"></i>
                                        <span class="label">è”ç³»ç”µè¯</span>
                                        <span class="value">${data.phone}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- è´¢åŠ¡ä¿¡æ¯å¡ç‰‡ -->
                            <div class="detail-card">
                                <div class="card-header">
                                    <i class="fas fa-credit-card"></i>
                                    <span>è´¢åŠ¡ä¿¡æ¯</span>
                                </div>
                                <div class="card-body">
                                    <div class="info-row">
                                        <i class="fas fa-money-bill-wave text-warning"></i>
                                        <span class="label">æŠ¼é‡‘é‡‘é¢</span>
                                        <span class="value money">Â¥${data.deposit.toFixed(2)}</span>
                                    </div>
                                    <div class="info-row">
                                        <i class="fas fa-calendar-check text-info"></i>
                                        <span class="label">å…¥ä½æ—¶é—´</span>
                                        <span class="value">${data.check_in_date || 'æœªå…¥ä½'}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- ç³»ç»Ÿä¿¡æ¯å¡ç‰‡ -->
                            <div class="detail-card">
                                <div class="card-header">
                                    <i class="fas fa-info-circle"></i>
                                    <span>ç³»ç»Ÿä¿¡æ¯</span>
                                </div>
                                <div class="card-body">
                                    <div class="info-row">
                                        <i class="fas fa-users text-secondary"></i>
                                        <span class="label">å…¥ä½äººæ•°</span>
                                        <span class="value">${data.occupant_count} äºº</span>
                                    </div>
                                    <div class="info-row">
                                        <i class="fas fa-clock text-muted"></i>
                                        <span class="label">åˆ›å»ºæ—¶é—´</span>
                                        <span class="value">${data.created_at}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- å¤‡æ³¨ä¿¡æ¯å¡ç‰‡ -->
                            <div class="detail-card full-width">
                                <div class="card-header">
                                    <i class="fas fa-sticky-note"></i>
                                    <span>å¤‡æ³¨ä¿¡æ¯</span>
                                </div>
                                <div class="card-body">
                                    <div class="remarks-content">
                                        <i class="fas fa-quote-left text-muted"></i>
                                        <p>${data.remarks || 'æš‚æ— å¤‡æ³¨ä¿¡æ¯'}</p>
                                        <i class="fas fa-quote-right text-muted"></i>
                                    </div>
                                </div>
                            </div>
                        </div>


                    `;

                    rentalInfoDetails.innerHTML = detailsHTML;
                    loadingSpinner.style.display = 'none';
                    rentalInfoDetails.style.display = 'block';
                })
                .catch(error => {
                    console.error('è·å–ç§Ÿæˆ¿ä¿¡æ¯å¤±è´¥:', error);
                    rentalInfoDetails.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            è·å–ç§Ÿæˆ¿ä¿¡æ¯å¤±è´¥: ${error.message}
                        </div>
                    `;
                    loadingSpinner.style.display = 'none';
                    rentalInfoDetails.style.display = 'block';
                });

            // è®¾ç½®ç¼–è¾‘æŒ‰é’®çš„äº‹ä»¶
            document.getElementById('editFromView').onclick = function () {
                modal.hide();
                editRentalInfo(id);
            };
        }

        // ç¼–è¾‘ç§Ÿæˆ¿ä¿¡æ¯
        function editRentalInfo(id) {
            // é‡ç½®è¡¨å•
            const form = document.getElementById('rentalInfoForm');
            form.reset();
            form.classList.remove('was-validated'); // ç§»é™¤éªŒè¯çŠ¶æ€
            document.getElementById('rentalInfoId').value = id;
            document.getElementById('rentalInfoModalLabel').innerHTML = '<i class="fas fa-edit me-2"></i>ç¼–è¾‘ç§Ÿæˆ¿ä¿¡æ¯';

            // è·å–ç§Ÿæˆ¿ä¿¡æ¯è¯¦æƒ…å¹¶å¡«å……è¡¨å•
            fetch(`/api/rental_info_old/${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // å¡«å……è¡¨å•æ•°æ®
                    document.getElementById('roomNumber').value = data.room_number;
                    document.getElementById('tenantName').value = data.tenant_name;
                    document.getElementById('phone').value = data.phone;
                    document.getElementById('deposit').value = data.deposit;
                    document.getElementById('occupantCount').value = data.occupant_count;
                    document.getElementById('checkInDate').value = data.check_in_date;
                    document.getElementById('rentalStatus').value = data.rental_status;
                    document.getElementById('remarks').value = data.remarks;
                })
                .catch(error => {
                    console.error('è·å–ç§Ÿæˆ¿ä¿¡æ¯å¤±è´¥:', error);
                    showNotification('è·å–ç§Ÿæˆ¿ä¿¡æ¯å¤±è´¥: ' + error.message, 'error');
                });

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modal = new bootstrap.Modal(document.getElementById('rentalInfoModal'));
            modal.show();
        }

        // åˆ é™¤ç§Ÿæˆ¿ä¿¡æ¯
        function deleteRentalInfo(id) {
            document.getElementById('deleteRentalInfoWarning').textContent = 'åˆ é™¤ç§Ÿæˆ¿ä¿¡æ¯å°†åŒæ—¶åˆ é™¤ç›¸å…³çš„ç§Ÿèµè®°å½•å’Œç¼´è´¹è®°å½•ã€‚';

            // è®¾ç½®ç¡®è®¤æŒ‰é’®çš„äº‹ä»¶
            document.getElementById('confirmDeleteRentalInfo').onclick = function () {
                // å‘é€åˆ é™¤è¯·æ±‚
                fetch(`/api/rental_info_old/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification(data.message, 'success');
                            // åˆ·æ–°é¡µé¢
                            setTimeout(() => {
                                location.reload();
                            }, 1000);
                        } else {
                            showNotification(data.message, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('åˆ é™¤å¤±è´¥:', error);
                        showNotification('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
                    });

                // å…³é—­æ¨¡æ€æ¡†
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteRentalInfoModal'));
                modal.hide();
            };

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modal = new bootstrap.Modal(document.getElementById('deleteRentalInfoModal'));
            modal.show();
        }

        // å¯¼å‡ºç§Ÿæˆ¿ä¿¡æ¯
        function exportRentalInfo(type) {
            alert(`å¯¼å‡º${type}ç§Ÿæˆ¿ä¿¡æ¯åŠŸèƒ½å°šæœªå®ç°`);
        }

        // æ˜¾ç¤ºç§Ÿæˆ¿ä¿¡æ¯æ±‡æ€»
        function showRentalInfoSummary() {
            alert('ç§Ÿæˆ¿ä¿¡æ¯æ±‡æ€»åŠŸèƒ½å°šæœªå®ç°');
        }

        // åŠ è½½ç©ºé—²æˆ¿é—´åˆ—è¡¨
        function loadAvailableRooms() {
            fetch('/api/available_rooms_old')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const roomSelect = document.getElementById('roomNumber');
                        // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™é»˜è®¤é€‰é¡¹ï¼‰
                        roomSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ç©ºé—²æˆ¿é—´</option>';

                        // æ·»åŠ ç©ºé—²æˆ¿é—´é€‰é¡¹
                        data.rooms.forEach(room => {
                            const option = document.createElement('option');
                            option.value = room.room_number;
                            option.textContent = `${room.room_number} - ${room.room_type} (åŸºç¡€ç§Ÿé‡‘: Â¥${room.base_rent})`;
                            roomSelect.appendChild(option);
                        });
                    } else {
                        console.error('åŠ è½½ç©ºé—²æˆ¿é—´å¤±è´¥:', data.message);
                        showNotification('åŠ è½½ç©ºé—²æˆ¿é—´å¤±è´¥: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½ç©ºé—²æˆ¿é—´å¤±è´¥:', error);
                    showNotification('åŠ è½½ç©ºé—²æˆ¿é—´å¤±è´¥: ' + error.message, 'error');
                });
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function () {
            loadAvailableRooms();
        });
    </script>
{% endblock %}